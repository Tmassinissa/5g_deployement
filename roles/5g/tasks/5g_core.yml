- name: Ensure destination directory exists
  ansible.builtin.file:
    path: /5g
    state: "directory"
  become: yes

- name: Copy oai-5g-core.tar.gz to the target host
  ansible.builtin.copy:
    src: oai-5g-core.tar.gz
    dest: /5g/oai-5g-core.tar.gz
  become: yes

- name: Extract files from oai-5g-core.tar.gz
  ansible.builtin.unarchive:
    src: /5g/oai-5g-core.tar.gz
    dest: /5g
    remote_src: true
  become: yes

- name: Update Helm dependencies
  command: helm dependency update
  args:
    chdir: /5g/oai-5g-core/oai-5g-basic

- name: Install Helm chart
  command: helm install oai-core /5g/oai-5g-core/oai-5g-basic

- name: Fetch status of core pods
  kubernetes.core.k8s_info:
    kind: Pod
    kubeconfig: /etc/kubernetes/admin.conf
    label_selectors:
      - "app.kubernetes.io/instance=oai-core"  # Adjust this to match your pods' labeling
  register: pod_info
  become: yes

- name: Verify all the core pods and their containers are ready
  ansible.builtin.command:
    cmd: "kubectl get pods --kubeconfig /etc/kubernetes/admin.conf -l app.kubernetes.io/instance=oai-core -o jsonpath='{.items[*].status.conditions[?(@.type==\"Ready\")].status}'"
  register: pod_ready_status
  until: pod_ready_status.stdout.split() | select("equalto", "True") | list | length == pod_info.resources | length
  retries: 30
  delay: 10
  become: yes

